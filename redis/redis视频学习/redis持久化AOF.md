## Redis持久化AOF

以日志的形式来记录每一个写操作（增量保存），将Redis执行过程中的所有写指令记录下来（读操作不记录），redis启动的时候会读取该文件重新构建数据，即重新执行所有的操作



#### AOF 持久化流程

1）客户端的请求写命令会被append追加到AOF缓冲区

2）AOF缓存区根据持久化策略[always,everysec,no]将操作sync写入到磁盘的AOF文件中

3）AOF文件大小超过重写策略或者手动重写的时候，会对AOF文件rewrite重写，压缩AOF文件容量

4）Redis服务重启时，会重新load加载AOF文件中的写操作来达到数据恢复的目的

#### AOF和RDB同时开启

AOF和RDB同时开启，默认取AOF得数据

#### AOF 重写

AOF方式持久化时记录的时一条一条的写命令，随着服务器运行的时间越来越长，AOF文件会越来越大，AOF重写就是为了解决这个问题。

函数`aof_rewrite`启动一个子进程创建AOF重写缓冲区，将Redis中所有的数据生成多条写命令写入AOF文件。在子进程进行AOF重写期间，服务器还会处理写请求的命令，这会导致服务器当前的数据库状态和重写后的AOF文件所保存的数据不一致。为了解决这个问题，子进程在执行AOF重写期间，服务器进程需要执行以下三件事情：

1、执行客户端发来的命令

2、将执行后的写命令追加到AOF缓冲区

3、将执行后的写命令追加到AOF重写缓冲区

当子进程完成了AOF重写后，发送信号到父进程，父进程收到信号后会调用信号处理函数（这个过程会阻塞父进程）

执行以下工作：

1、将AOF重写缓冲区的数据全部写入新的AOF文件中，这时候新AOF文件所保存的数据库状态和服务器当前的数据状态一致

2、对新AOF文件改名，覆盖原有的AOF文件

#### AOF 优势

- 丢失数据概率低
- 可读性日志文本

缺点

- 比RDB占用更多的磁盘空间
- 恢复备份速度慢
- 每次的写操作都同步，有性能压力

#### AOF和RDB的区别

- RDB可以理解为是一种全量数据更新机制(每次复制全部)，AOF可以理解为是一种增量的更新机制，AOF重写可以理解为是一种全量+增量的更新机制（第一次是全量，后面都是增量，增加指令）
- RDB适合服务器数据库数据量小，写命令频繁的场景
- AOF适合数据量大，写命令少的场景
- AOF重写适合在AOF运行了很久的写命令之后执行