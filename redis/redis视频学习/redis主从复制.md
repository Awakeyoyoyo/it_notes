## Redis 主从复制

### 含义

主机数据更新后根据配置和策略，自动同步到备机的机制master/slaver机制，Master以写为主，Slave以读为主。

### 好处

- 读写分离->主服负责写，从服负责读
- 容灾快速恢复->从服挂了，可以快速从主服获取数据来恢复 。   主服挂了->XX



### Redis主从复制 配置过程

#### 一主两从

命令：

`info replication` 打印主从关系

从服配置：

slaveof <ip><port>   //成为ip:port上Reids的从服

从机不能写只能读取



#### 复制原理

**slave服务器主动**（全量复制）

1、slave服务器连上主服务器后，slave服务器向master服务器发送数据同步消息

2、matser服务器街道slave服务器发送的同步消息，把matser服务器数据进行持久化，生成rdb文件，把rdb文件发送到slave服务器

3、slave拿到rdb文件会进行数据恢复

**master服务器主动**（增量复制）

每次master服务器进行写操作之后，会和slave服务器进行数据同步



#### 薪火相传

> 即从服务器还可以有其下面的从服务器

#### 反客为主

`slaveof no one`讲从服务器变成主机 （需要手动）

哨兵模式则是自动的反客为主



#### 哨兵模式

> 配置文件中配置：`sentinel monitor mymaster ip port 1`  （1）表示至少有多少个哨兵同意迁移

即实际生成中，

1）主服务器挂了，其下面的从服务自动升级为主服务器

2）主服务器重启后会变成从服务器

##### 缺点

复制延时：由于所有的写操作都在Master上操作，然后同步到slave上，所以master同步到slave机器有延迟，当西塔繁忙或者slave机器数量多的时候会严重

##### 选择过程

1、选择优先级排名靠前   配置文件中配置`slave-priority`

2、选择偏移量最大的。偏移量最大则代表数据最安全

3、选择runid最小的slave服务器